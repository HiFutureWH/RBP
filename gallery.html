<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Structure + Sequence + Notes</title>

  <style>
    :root {
      --view-h: 360px;  /* 结构视窗高度 */
      --view-w: 420px;  /* 结构视窗宽度 */
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: sans-serif; }
    h1   { margin: 16px; }

    /* 整体纵向排一行一行 */
    #grid {
      display: flex;
      flex-direction: column;
      gap: 20px;
      padding: 0 16px 32px;
    }

    /* 每行横向四列 */
    .row {
      display: flex;
      gap: 16px;
      align-items: flex-start;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
    }

    /* ID 标签 */
    .id-tag {
      flex-shrink: 0;
      max-width: 90px;
      font: 14px/1.2 monospace;
      padding: 6px 8px;
      background: #e9eef6;
      border: 1px solid #cbd6e2;
      border-radius: 4px;
      word-break: break-all;
      text-align: center;
    }

    /* 结构 iframe */
    iframe {
      width: var(--view-w);
      height: var(--view-h);
      border: 0;
      flex-shrink: 0;
    }

    /* FASTA 序列框 */
    .seq-box {
      flex: 1;
      max-height: var(--view-h);
      overflow: auto;
      background: #fafafa;
      border: 1px solid #eee;
      padding: 6px 8px;
      white-space: pre-wrap;
      font: 14px/1.4 monospace;
    }
    .seq-box.loading { color: #888; }

    /* 可编辑笔记框 */
    .note-box {
      flex: 1;
      max-height: var(--view-h);
      overflow: auto;
      background: #fffef6;
      border: 1px solid #d4cfa7;
      padding: 6px 8px;
      white-space: pre-wrap;
      font: 14px/1.4 monospace;
    }
    .note-box[contenteditable="true"]:empty:before {
      content: "Add notes here…";
      color: #bbb;
    }
  </style>
</head>
<body>
  <h1>Structure • Sequence • Notes</h1>
  <div id="grid"></div>

<script>
  /* ---------------------- 路径常量 ---------------------- */
  const CSV_URL    = 'https://raw.githubusercontent.com/HiFutureWH/RBP/main/list/File_Name_List.csv';
  const BASE_PDB   = 'https://raw.githubusercontent.com/HiFutureWH/RBP/main/interaction_structures/';
  const BASE_FASTA = 'https://raw.githubusercontent.com/HiFutureWH/RBP/main/sequence/';

  /* ---------------------- 主流程 ------------------------ */
  fetch(CSV_URL)
    .then(r => r.text())
    .then(text => {
      const files = text.trim().split(/\r?\n/).slice(1).filter(Boolean);  // 去掉表头
      const grid  = document.getElementById('grid');

      files.forEach(name => {
        const id   = name.replace(/\.\w+$/, '');       // 去掉扩展名
        const pdb  = BASE_PDB   + name;
        const fastaUrl = BASE_FASTA + id + '.fasta';

        /* === 构造 DOM === */
        const row = document.createElement('div');
        row.className = 'row';

        /* ID 标签 */
        const tag = document.createElement('div');
        tag.className = 'id-tag';
        tag.textContent = id;
        row.appendChild(tag);

        /* 结构视窗 */
        const ifr = document.createElement('iframe');
        ifr.loading = 'lazy';
        ifr.src = 'viewer-frame.html?url=' + encodeURIComponent(pdb);
        row.appendChild(ifr);

        /* FASTA 框 */
        const seq = document.createElement('pre');
        seq.className = 'seq-box loading';
        seq.textContent = 'Loading ' + id + '.fasta …';
        row.appendChild(seq);

        /* 笔记框 */
        const note = document.createElement('pre');
        note.className = 'note-box';
        note.contentEditable = 'true';
        note.spellcheck = false;
        row.appendChild(note);

        /* 载入已保存笔记 */
        const saved = localStorage.getItem('note_' + id);
        if (saved) note.textContent = saved;

        /* 保存事件 */
        note.addEventListener('input', () => {
          localStorage.setItem('note_' + id, note.textContent.trim());
        });

        /* 挂到网格 */
        grid.appendChild(row);

        /* 拉取 FASTA */
        fetch(fastaUrl)
          .then(r => r.ok ? r.text() : '⚠️  not found')
          .then(txt => {
            seq.classList.remove('loading');
            seq.textContent = txt;
          })
          .catch(e => {
            seq.classList.remove('loading');
            seq.textContent = '⚠️  fetch error';
            console.error(e);
          });
      });
    })
    .catch(e => {
      console.error(e);
      alert('CSV 读取失败');
    });
</script>
</body>
</html>
